# ArkPlot 数据库集成应用计划（修正版）

## 概述

基于实际代码分析，本计划专注于如何将已实现的SqlSugar数据库集成到现有业务代码中，而非从头开始构建。

## 实际现状

### ✅ 已完成的工作
- **SqlSugar模型已绑定**：Plot和FormattedTextEntry已配置SugarTable/SugarColumn
- **Repository模式已建立**：BaseRepository<T>、具体Repository类已实现
- **测试用例已完善**：DbTests项目中已覆盖所有CRUD操作
- **DatabaseService已存在**：提供数据库管理功能
- **CodeFirst已配置**：DatabaseContext自动初始化表结构

### 实际架构
```
ArkPlotWpf/
├── Model/
│   ├── Plot.cs (已绑定SugarTable)
│   ├── FormattedTextEntry.cs (已绑定SugarTable)
│   └── PrtsData.cs (已绑定SugarTable)
├── Data/
│   ├── DatabaseContext.cs (单例模式)
│   ├── DatabaseService.cs (数据库管理中心)
│   └── Repositories/
│       ├── BaseRepository.cs (通用CRUD)
│       ├── PlotRepository.cs
│       └── FormattedTextEntryRepository.cs
└── ArkPlotWpf.DbTests/
    └── RepositoryTests.cs (完整测试覆盖)
```

## DatabaseService.cs功能定位

**核心作用**：数据库生命周期管理中心

| 功能类别 | 方法 | 用途 |
|---------|------|------|
| **初始化** | `Initialize()` | 执行数据库迁移 |
| **运维** | `Backup()/Restore()` | 备份/恢复数据库 |
| **监控** | `GetStatistics()` | 获取数据库统计信息 |
| **维护** | `Cleanup()` | 清理空数据、优化 |
| **诊断** | `CheckConnection()` | 检查连接状态 |
| **容量** | `GetDatabaseSize()` | 获取数据库大小 |

## 实际集成方案

### 1. 在Utilities中的直接应用

#### 1.1 PrtsDataProcessor集成
```csharp
// 文件：ArkPlotWpf/Utilities/PrtsComponents/PrtsDataProcessor.cs
public class PrtsDataProcessor
{
    private readonly PlotRepository _plotRepo = new();
    private readonly FormattedTextEntryRepository _textRepo = new();
    
    public async Task SaveActDataAsync(string actName, List<Plot> plots)
    {
        await _plotRepo.UseTransactionAsync(async () =>
        {
            // 删除旧数据（如需要）
            await _plotRepo.DeleteAsync(p => p.Title.Contains(actName));
            
            // 批量插入新数据
            await _plotRepo.AddRangeAsync(plots);
        });
    }
    
    public async Task<List<Plot>> LoadActDataAsync(string actName)
    {
        return await _plotRepo.GetWhereAsync(p => p.Title.Contains(actName));
    }
}
```

#### 1.2 AkpParser集成
```csharp
// 文件：ArkPlotWpf/Utilities/WorkFlow/AkpParser.cs
public class AkpParser
{
    private readonly PlotRepository _plotRepo = new();
    
    public async Task SaveProcessedPlotAsync(Plot plot, List<FormattedTextEntry> entries)
    {
        // 保存Plot
        var plotId = await _plotRepo.AddAsync(plot);
        
        // 保存关联的FormattedTextEntry
        foreach (var entry in entries)
        {
            // 注意：需要给FormattedTextEntry添加PlotId属性用于关联
            entry.PlotId = plotId;
            await _textEntryRepo.AddAsync(entry);
        }
    }
}
```

#### 1.3 PlotManager集成
```csharp
// 文件：ArkPlotWpf/Utilities/TagProcessingComponents/PlotManager.cs
public class PlotManager
{
    private readonly PlotRepository _plotRepo = new();
    
    public async Task<Plot> GetPlotByTitleAsync(string title)
    {
        return await _plotRepo.FirstOrDefaultAsync(p => p.Title == title);
    }
    
    public async Task<List<Plot>> SearchPlotsAsync(string keyword)
    {
        return await _plotRepo.GetWhereAsync(p => 
            p.Title.Contains(keyword) || 
            p.ContentText.Contains(keyword));
    }
}
```

### 2. 在MainViewModel中的集成

```csharp
// 文件：ArkPlotWpf/ViewModel/MainViewModel.cs
public partial class MainWindowViewModel : ObservableObject
{
    public MainWindowViewModel()
    {
        // 初始化数据库（只需一次）
        DatabaseService.Instance.Initialize();
        
        // 检查数据库状态
        if (DatabaseService.Instance.CheckConnection())
        {
            LoadDatabaseStats();
        }
    }
    
    [ObservableProperty]
    private DatabaseStatistics databaseStats = new();
    
    [RelayCommand]
    private void LoadDatabaseStats()
    {
        DatabaseStats = DatabaseService.Instance.GetStatistics();
    }
    
    [RelayCommand]
    private async Task SearchPlotsAsync(string keyword)
    {
        var plotRepo = new PlotRepository();
        var results = await plotRepo.GetWhereAsync(p => 
            p.Title.Contains(keyword));
        
        // 绑定到UI显示
    }
}
```

### 3. 实际数据模型优化

#### 3.1 给FormattedTextEntry添加PlotId关联
```csharp
// 在FormattedTextEntry.cs中添加
public class FormattedTextEntry
{
    [SugarColumn(ColumnDataType = "INTEGER", IsNullable = true)]
    public long PlotId { get; set; } // 关联到Plot的Id
    
    // ... 其他属性保持不变
}
```

#### 3.2 给Plot添加活动标识
```csharp
// 在Plot.cs中添加
public class Plot
{
    [SugarColumn(Length = 100, IsNullable = true)]
    public string ActName { get; set; } = ""; // 活动名称
    
    [SugarColumn(IsNullable = true)]
    public DateTime CreatedAt { get; set; } = DateTime.Now;
    
    // ... 其他属性保持不变
}
```

## 实际使用模式

### 基本CRUD操作
```csharp
// 1. 创建和保存
var plot = new Plot("第一章", new StringBuilder("剧情内容..."));
await _plotRepo.AddAsync(plot);

// 2. 查询
var allPlots = await _plotRepo.GetAllAsync();
var specificPlots = await _plotRepo.GetWhereAsync(p => p.ActName == "骑兵与猎人");

// 3. 更新
plot.Title = "第一章（更新）";
await _plotRepo.UpdateAsync(plot);

// 4. 删除
await _plotRepo.DeleteAsync(p => p.Id == plotId);
```

### 事务处理
```csharp
await _plotRepo.UseTransactionAsync(async () =>
{
    // 多个操作在一个事务中
    await _plotRepo.DeleteAsync(p => p.ActName == "骑兵与猎人");
    await _plotRepo.AddRangeAsync(newPlots);
});
```

### 分页查询
```csharp
var (plots, total) = await _plotRepo.GetPageAsync(
    pageIndex: 1,
    pageSize: 20,
    where: p => p.ActName.Contains("骑兵")
);
```

## 数据库初始化流程

### 1. 应用启动时初始化
```csharp
// 在App.xaml.cs中
protected override async void OnStartup(StartupEventArgs e)
{
    base.OnStartup(e);
    
    // 初始化数据库（自动创建表结构）
    DatabaseService.Instance.Initialize();
    
    // 可选：显示数据库统计
    var stats = DatabaseService.Instance.GetStatistics();
    Console.WriteLine(stats);
}
```

### 2. 数据迁移策略（从JSON到数据库）
```csharp
public class JsonToDbMigrator
{
    public async Task MigrateFromJsonAsync(string jsonFilePath)
    {
        var plotRepo = new PlotRepository();
        
        // 读取现有JSON
        var json = await File.ReadAllTextAsync(jsonFilePath);
        var plots = JsonSerializer.Deserialize<List<Plot>>(json);
        
        // 批量迁移
        await plotRepo.AddRangeAsync(plots);
        
        Console.WriteLine($"迁移完成：{plots.Count}个剧情已保存到数据库");
    }
}
```

## 性能监控

### 实时统计
```csharp
// 在UI中显示数据库状态
public class DatabaseMonitor
{
    public string GetStatus()
    {
        var stats = DatabaseService.Instance.GetStatistics();
        var size = DatabaseService.Instance.GetDatabaseSize();
        
        return $"""
            数据库统计：
            - 剧情数量：{stats.PlotCount}
            - 文本条目：{stats.FormattedTextEntryCount}
            - 数据库大小：{size / 1024 / 1024:F2} MB
            - 最后更新：{stats.LastUpdated:yyyy-MM-dd HH:mm:ss}
            """;
    }
}
```

## 实际集成检查清单

### ✅ 立即可用
- [x] Repository类已完整实现
- [x] 模型已正确绑定
- [x] 测试用例已通过
- [x] DatabaseService已提供管理功能

### 🔧 需要的小调整
- [ ] 给FormattedTextEntry添加PlotId字段用于关联
- [ ] 给Plot添加ActName字段用于活动分类
- [ ] 在Utilities类中实例化对应的Repository

### 📋 集成步骤
1. **添加关联字段**（5分钟）
2. **在Utilities中使用Repository**（10分钟/类）
3. **在MainViewModel中添加数据库初始化**（2分钟）
4. **运行测试验证**（1分钟）

**总计时间：20-30分钟即可完成基础集成**