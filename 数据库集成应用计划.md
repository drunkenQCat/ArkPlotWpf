# ArkPlot æ•°æ®åº“é›†æˆåº”ç”¨è®¡åˆ’ï¼ˆä¿®æ­£ç‰ˆï¼‰

## æ¦‚è¿°

åŸºäºå®é™…ä»£ç åˆ†æï¼Œæœ¬è®¡åˆ’ä¸“æ³¨äºå¦‚ä½•å°†å·²å®ç°çš„SqlSugaræ•°æ®åº“é›†æˆåˆ°ç°æœ‰ä¸šåŠ¡ä»£ç ä¸­ï¼Œè€Œéä»å¤´å¼€å§‹æ„å»ºã€‚

## å®é™…ç°çŠ¶

### âœ… å·²å®Œæˆçš„å·¥ä½œ
- **SqlSugaræ¨¡å‹å·²ç»‘å®š**ï¼šPlotå’ŒFormattedTextEntryå·²é…ç½®SugarTable/SugarColumn
- **Repositoryæ¨¡å¼å·²å»ºç«‹**ï¼šBaseRepository<T>ã€å…·ä½“Repositoryç±»å·²å®ç°
- **æµ‹è¯•ç”¨ä¾‹å·²å®Œå–„**ï¼šDbTestsé¡¹ç›®ä¸­å·²è¦†ç›–æ‰€æœ‰CRUDæ“ä½œ
- **DatabaseServiceå·²å­˜åœ¨**ï¼šæä¾›æ•°æ®åº“ç®¡ç†åŠŸèƒ½
- **CodeFirstå·²é…ç½®**ï¼šDatabaseContextè‡ªåŠ¨åˆå§‹åŒ–è¡¨ç»“æ„

### å®é™…æ¶æ„
```
ArkPlotWpf/
â”œâ”€â”€ Model/
â”‚   â”œâ”€â”€ Plot.cs (å·²ç»‘å®šSugarTable)
â”‚   â”œâ”€â”€ FormattedTextEntry.cs (å·²ç»‘å®šSugarTable)
â”‚   â””â”€â”€ PrtsData.cs (å·²ç»‘å®šSugarTable)
â”œâ”€â”€ Data/
â”‚   â”œâ”€â”€ DatabaseContext.cs (å•ä¾‹æ¨¡å¼)
â”‚   â”œâ”€â”€ DatabaseService.cs (æ•°æ®åº“ç®¡ç†ä¸­å¿ƒ)
â”‚   â””â”€â”€ Repositories/
â”‚       â”œâ”€â”€ BaseRepository.cs (é€šç”¨CRUD)
â”‚       â”œâ”€â”€ PlotRepository.cs
â”‚       â””â”€â”€ FormattedTextEntryRepository.cs
â””â”€â”€ ArkPlotWpf.DbTests/
    â””â”€â”€ RepositoryTests.cs (å®Œæ•´æµ‹è¯•è¦†ç›–)
```

## DatabaseService.csåŠŸèƒ½å®šä½

**æ ¸å¿ƒä½œç”¨**ï¼šæ•°æ®åº“ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸­å¿ƒ

| åŠŸèƒ½ç±»åˆ« | æ–¹æ³• | ç”¨é€” |
|---------|------|------|
| **åˆå§‹åŒ–** | `Initialize()` | æ‰§è¡Œæ•°æ®åº“è¿ç§» |
| **è¿ç»´** | `Backup()/Restore()` | å¤‡ä»½/æ¢å¤æ•°æ®åº“ |
| **ç›‘æ§** | `GetStatistics()` | è·å–æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯ |
| **ç»´æŠ¤** | `Cleanup()` | æ¸…ç†ç©ºæ•°æ®ã€ä¼˜åŒ– |
| **è¯Šæ–­** | `CheckConnection()` | æ£€æŸ¥è¿æ¥çŠ¶æ€ |
| **å®¹é‡** | `GetDatabaseSize()` | è·å–æ•°æ®åº“å¤§å° |

## å®é™…é›†æˆæ–¹æ¡ˆ

### 1. åœ¨Utilitiesä¸­çš„ç›´æ¥åº”ç”¨

#### 1.1 PrtsDataProcessoré›†æˆ
```csharp
// æ–‡ä»¶ï¼šArkPlotWpf/Utilities/PrtsComponents/PrtsDataProcessor.cs
public class PrtsDataProcessor
{
    private readonly PlotRepository _plotRepo = new();
    private readonly FormattedTextEntryRepository _textRepo = new();
    
    public async Task SaveActDataAsync(string actName, List<Plot> plots)
    {
        await _plotRepo.UseTransactionAsync(async () =>
        {
            // åˆ é™¤æ—§æ•°æ®ï¼ˆå¦‚éœ€è¦ï¼‰
            await _plotRepo.DeleteAsync(p => p.Title.Contains(actName));
            
            // æ‰¹é‡æ’å…¥æ–°æ•°æ®
            await _plotRepo.AddRangeAsync(plots);
        });
    }
    
    public async Task<List<Plot>> LoadActDataAsync(string actName)
    {
        return await _plotRepo.GetWhereAsync(p => p.Title.Contains(actName));
    }
}
```

#### 1.2 AkpParseré›†æˆ
```csharp
// æ–‡ä»¶ï¼šArkPlotWpf/Utilities/WorkFlow/AkpParser.cs
public class AkpParser
{
    private readonly PlotRepository _plotRepo = new();
    
    public async Task SaveProcessedPlotAsync(Plot plot, List<FormattedTextEntry> entries)
    {
        // ä¿å­˜Plot
        var plotId = await _plotRepo.AddAsync(plot);
        
        // ä¿å­˜å…³è”çš„FormattedTextEntry
        foreach (var entry in entries)
        {
            // æ³¨æ„ï¼šéœ€è¦ç»™FormattedTextEntryæ·»åŠ PlotIdå±æ€§ç”¨äºå…³è”
            entry.PlotId = plotId;
            await _textEntryRepo.AddAsync(entry);
        }
    }
}
```

#### 1.3 PlotManageré›†æˆ
```csharp
// æ–‡ä»¶ï¼šArkPlotWpf/Utilities/TagProcessingComponents/PlotManager.cs
public class PlotManager
{
    private readonly PlotRepository _plotRepo = new();
    
    public async Task<Plot> GetPlotByTitleAsync(string title)
    {
        return await _plotRepo.FirstOrDefaultAsync(p => p.Title == title);
    }
    
    public async Task<List<Plot>> SearchPlotsAsync(string keyword)
    {
        return await _plotRepo.GetWhereAsync(p => 
            p.Title.Contains(keyword) || 
            p.ContentText.Contains(keyword));
    }
}
```

### 2. åœ¨MainViewModelä¸­çš„é›†æˆ

```csharp
// æ–‡ä»¶ï¼šArkPlotWpf/ViewModel/MainViewModel.cs
public partial class MainWindowViewModel : ObservableObject
{
    public MainWindowViewModel()
    {
        // åˆå§‹åŒ–æ•°æ®åº“ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
        DatabaseService.Instance.Initialize();
        
        // æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
        if (DatabaseService.Instance.CheckConnection())
        {
            LoadDatabaseStats();
        }
    }
    
    [ObservableProperty]
    private DatabaseStatistics databaseStats = new();
    
    [RelayCommand]
    private void LoadDatabaseStats()
    {
        DatabaseStats = DatabaseService.Instance.GetStatistics();
    }
    
    [RelayCommand]
    private async Task SearchPlotsAsync(string keyword)
    {
        var plotRepo = new PlotRepository();
        var results = await plotRepo.GetWhereAsync(p => 
            p.Title.Contains(keyword));
        
        // ç»‘å®šåˆ°UIæ˜¾ç¤º
    }
}
```

### 3. å®é™…æ•°æ®æ¨¡å‹ä¼˜åŒ–

#### 3.1 ç»™FormattedTextEntryæ·»åŠ PlotIdå…³è”
```csharp
// åœ¨FormattedTextEntry.csä¸­æ·»åŠ 
public class FormattedTextEntry
{
    [SugarColumn(ColumnDataType = "INTEGER", IsNullable = true)]
    public long PlotId { get; set; } // å…³è”åˆ°Plotçš„Id
    
    // ... å…¶ä»–å±æ€§ä¿æŒä¸å˜
}
```

#### 3.2 ç»™Plotæ·»åŠ æ´»åŠ¨æ ‡è¯†
```csharp
// åœ¨Plot.csä¸­æ·»åŠ 
public class Plot
{
    [SugarColumn(Length = 100, IsNullable = true)]
    public string ActName { get; set; } = ""; // æ´»åŠ¨åç§°
    
    [SugarColumn(IsNullable = true)]
    public DateTime CreatedAt { get; set; } = DateTime.Now;
    
    // ... å…¶ä»–å±æ€§ä¿æŒä¸å˜
}
```

## å®é™…ä½¿ç”¨æ¨¡å¼

### åŸºæœ¬CRUDæ“ä½œ
```csharp
// 1. åˆ›å»ºå’Œä¿å­˜
var plot = new Plot("ç¬¬ä¸€ç« ", new StringBuilder("å‰§æƒ…å†…å®¹..."));
await _plotRepo.AddAsync(plot);

// 2. æŸ¥è¯¢
var allPlots = await _plotRepo.GetAllAsync();
var specificPlots = await _plotRepo.GetWhereAsync(p => p.ActName == "éª‘å…µä¸çŒäºº");

// 3. æ›´æ–°
plot.Title = "ç¬¬ä¸€ç« ï¼ˆæ›´æ–°ï¼‰";
await _plotRepo.UpdateAsync(plot);

// 4. åˆ é™¤
await _plotRepo.DeleteAsync(p => p.Id == plotId);
```

### äº‹åŠ¡å¤„ç†
```csharp
await _plotRepo.UseTransactionAsync(async () =>
{
    // å¤šä¸ªæ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­
    await _plotRepo.DeleteAsync(p => p.ActName == "éª‘å…µä¸çŒäºº");
    await _plotRepo.AddRangeAsync(newPlots);
});
```

### åˆ†é¡µæŸ¥è¯¢
```csharp
var (plots, total) = await _plotRepo.GetPageAsync(
    pageIndex: 1,
    pageSize: 20,
    where: p => p.ActName.Contains("éª‘å…µ")
);
```

## æ•°æ®åº“åˆå§‹åŒ–æµç¨‹

### 1. åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–
```csharp
// åœ¨App.xaml.csä¸­
protected override async void OnStartup(StartupEventArgs e)
{
    base.OnStartup(e);
    
    // åˆå§‹åŒ–æ•°æ®åº“ï¼ˆè‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„ï¼‰
    DatabaseService.Instance.Initialize();
    
    // å¯é€‰ï¼šæ˜¾ç¤ºæ•°æ®åº“ç»Ÿè®¡
    var stats = DatabaseService.Instance.GetStatistics();
    Console.WriteLine(stats);
}
```

### 2. æ•°æ®è¿ç§»ç­–ç•¥ï¼ˆä»JSONåˆ°æ•°æ®åº“ï¼‰
```csharp
public class JsonToDbMigrator
{
    public async Task MigrateFromJsonAsync(string jsonFilePath)
    {
        var plotRepo = new PlotRepository();
        
        // è¯»å–ç°æœ‰JSON
        var json = await File.ReadAllTextAsync(jsonFilePath);
        var plots = JsonSerializer.Deserialize<List<Plot>>(json);
        
        // æ‰¹é‡è¿ç§»
        await plotRepo.AddRangeAsync(plots);
        
        Console.WriteLine($"è¿ç§»å®Œæˆï¼š{plots.Count}ä¸ªå‰§æƒ…å·²ä¿å­˜åˆ°æ•°æ®åº“");
    }
}
```

## æ€§èƒ½ç›‘æ§

### å®æ—¶ç»Ÿè®¡
```csharp
// åœ¨UIä¸­æ˜¾ç¤ºæ•°æ®åº“çŠ¶æ€
public class DatabaseMonitor
{
    public string GetStatus()
    {
        var stats = DatabaseService.Instance.GetStatistics();
        var size = DatabaseService.Instance.GetDatabaseSize();
        
        return $"""
            æ•°æ®åº“ç»Ÿè®¡ï¼š
            - å‰§æƒ…æ•°é‡ï¼š{stats.PlotCount}
            - æ–‡æœ¬æ¡ç›®ï¼š{stats.FormattedTextEntryCount}
            - æ•°æ®åº“å¤§å°ï¼š{size / 1024 / 1024:F2} MB
            - æœ€åæ›´æ–°ï¼š{stats.LastUpdated:yyyy-MM-dd HH:mm:ss}
            """;
    }
}
```

## å®é™…é›†æˆæ£€æŸ¥æ¸…å•

### âœ… ç«‹å³å¯ç”¨
- [x] Repositoryç±»å·²å®Œæ•´å®ç°
- [x] æ¨¡å‹å·²æ­£ç¡®ç»‘å®š
- [x] æµ‹è¯•ç”¨ä¾‹å·²é€šè¿‡
- [x] DatabaseServiceå·²æä¾›ç®¡ç†åŠŸèƒ½

### ğŸ”§ éœ€è¦çš„å°è°ƒæ•´
- [ ] ç»™FormattedTextEntryæ·»åŠ PlotIdå­—æ®µç”¨äºå…³è”
- [ ] ç»™Plotæ·»åŠ ActNameå­—æ®µç”¨äºæ´»åŠ¨åˆ†ç±»
- [ ] åœ¨Utilitiesç±»ä¸­å®ä¾‹åŒ–å¯¹åº”çš„Repository

### ğŸ“‹ é›†æˆæ­¥éª¤
1. **æ·»åŠ å…³è”å­—æ®µ**ï¼ˆ5åˆ†é’Ÿï¼‰
2. **åœ¨Utilitiesä¸­ä½¿ç”¨Repository**ï¼ˆ10åˆ†é’Ÿ/ç±»ï¼‰
3. **åœ¨MainViewModelä¸­æ·»åŠ æ•°æ®åº“åˆå§‹åŒ–**ï¼ˆ2åˆ†é’Ÿï¼‰
4. **è¿è¡Œæµ‹è¯•éªŒè¯**ï¼ˆ1åˆ†é’Ÿï¼‰

**æ€»è®¡æ—¶é—´ï¼š20-30åˆ†é’Ÿå³å¯å®ŒæˆåŸºç¡€é›†æˆ**