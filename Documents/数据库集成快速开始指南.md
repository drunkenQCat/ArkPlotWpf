# æ•°æ®åº“é›†æˆå¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸš€ ç«‹å³å¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡

1. **ç¡®è®¤å½“å‰çŠ¶æ€**
   ```bash
   # æ£€æŸ¥é¡¹ç›®ç¼–è¯‘çŠ¶æ€
   dotnet build
   
   # è¿è¡Œç°æœ‰æµ‹è¯•
   dotnet test
   ```

2. **å¤‡ä»½é‡è¦æ•°æ®**
   ```bash
   # å¤‡ä»½JSONæ–‡ä»¶
   cp ArkPlotWpf/all_plots.json ArkPlotWpf/all_plots.json.backup
   cp ArkPlotWpf/all_plots_1.json ArkPlotWpf/all_plots_1.json.backup
   cp ArkPlotWpf/tags.json ArkPlotWpf/tags.json.backup
   ```

### ç¬¬äºŒæ­¥ï¼šå¼€å§‹ç¬¬ä¸€é˜¶æ®µå®æ–½

#### 2.1 åˆ›å»ºç¼ºå¤±çš„Entityç±»

é¦–å…ˆåˆ›å»º `ActEntity`ï¼š

```csharp
// ArkPlotWpf/Data/Entities/ActEntity.cs
using System;

namespace ArkPlotWpf.Data.Entities;

public class ActEntity
{
    public long Id { get; set; }
    public string Title { get; set; } = string.Empty;
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}
```

#### 2.2 åˆ›å»º `ActRepository`

```csharp
// ArkPlotWpf/Data/Repositories/ActRepository.cs
using ArkPlotWpf.Data.Entities;
using ArkPlotWpf.Model;
using Dapper;

namespace ArkPlotWpf.Data.Repositories;

public class ActRepository : BaseRepository, IActRepository
{
    public ActRepository(string? connectionString = null) : base(connectionString)
    {
        DatabaseMigration.Migrate(_connectionString);
    }

    public async Task<Act> GetByTitleAsync(string title)
    {
        var entity = await QuerySingleOrDefaultAsync<ActEntity>(
            "SELECT * FROM Acts WHERE Title = @Title",
            new { Title = title });

        return entity?.ToModel();
    }

    public async Task<IEnumerable<Act>> GetAllAsync()
    {
        var entities = await QueryAsync<ActEntity>("SELECT * FROM Acts ORDER BY Title");
        return entities.Select(e => e.ToModel());
    }

    public async Task<long> AddAsync(Act act)
    {
        var entity = act.ToEntity();
        var sql = """
        INSERT INTO Acts (Title, CreatedAt, UpdatedAt)
        VALUES (@Title, @CreatedAt, @UpdatedAt);
        SELECT last_insert_rowid();
        """;

        return await ExecuteScalarAsync<long>(sql, entity);
    }

    public async Task<bool> UpdateAsync(Act act)
    {
        var entity = act.ToEntity();
        entity.UpdatedAt = DateTime.UtcNow;
        
        var sql = """
        UPDATE Acts 
        SET Title = @Title, UpdatedAt = @UpdatedAt
        WHERE Id = @Id
        """;

        var rowsAffected = await ExecuteAsync(sql, entity);
        return rowsAffected > 0;
    }

    public async Task<bool> DeleteAsync(long id)
    {
        var sql = "DELETE FROM Acts WHERE Id = @Id";
        var rowsAffected = await ExecuteAsync(sql, new { Id = id });
        return rowsAffected > 0;
    }
}
```

#### 2.3 åˆ›å»º `ActMapper`

```csharp
// ArkPlotWpf/Data/Mappers/ActMapper.cs
using ArkPlotWpf.Data.Entities;
using ArkPlotWpf.Model;

namespace ArkPlotWpf.Data.Mappers;

public class ActMapper : IMapper<Act, ActEntity>
{
    public ActEntity ToEntity(Act model)
    {
        if (model == null)
            return null!;

        return new ActEntity
        {
            Id = model.Id,
            Title = model.Title,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };
    }

    public Act ToModel(ActEntity entity)
    {
        if (entity == null)
            return null!;

        return new Act(entity.Title, new System.Text.StringBuilder())
        {
            Id = entity.Id
        };
    }
}
```

#### 2.4 åˆ›å»ºæ¥å£

```csharp
// ArkPlotWpf/Data/Repositories/IActRepository.cs
using ArkPlotWpf.Model;

namespace ArkPlotWpf.Data.Repositories;

public interface IActRepository
{
    Task<Act> GetByTitleAsync(string title);
    Task<IEnumerable<Act>> GetAllAsync();
    Task<long> AddAsync(Act act);
    Task<bool> UpdateAsync(Act act);
    Task<bool> DeleteAsync(long id);
}
```

### ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•æ–°åŠŸèƒ½

#### 3.1 åˆ›å»ºæµ‹è¯•

```csharp
// ArkPlotWpf.DbTests/Database/Repositories/ActRepositoryTests.cs
using ArkPlotWpf.Data.Repositories;
using ArkPlotWpf.Model;
using Xunit;

namespace ArkPlotWpf.DbTests.Database.Repositories;

public class ActRepositoryTests : IDisposable
{
    private readonly string _testDbPath;
    private readonly ActRepository _repository;

    public ActRepositoryTests()
    {
        _testDbPath = Path.GetTempFileName();
        _repository = new ActRepository($"Data Source={_testDbPath}");
    }

    public void Dispose()
    {
        try
        {
            if (File.Exists(_testDbPath))
            {
                File.Delete(_testDbPath);
            }
        }
        catch
        {
            // å¿½ç•¥åˆ é™¤å¤±è´¥çš„æƒ…å†µ
        }
    }

    [Fact]
    public async Task AddAct_ShouldReturnValidId()
    {
        // Arrange
        var act = new Act("TestAct", new System.Text.StringBuilder());

        // Act
        var id = await _repository.AddAsync(act);

        // Assert
        Assert.True(id > 0);
    }

    [Fact]
    public async Task GetByTitle_ShouldReturnCorrectAct()
    {
        // Arrange
        var act = new Act("TestAct", new System.Text.StringBuilder());
        await _repository.AddAsync(act);

        // Act
        var result = await _repository.GetByTitleAsync("TestAct");

        // Assert
        Assert.NotNull(result);
        Assert.Equal("TestAct", result.Title);
    }
}
```

#### 3.2 è¿è¡Œæµ‹è¯•

```bash
cd ArkPlotWpf.DbTests
dotnet test --filter "ActRepositoryTests"
```

### ç¬¬å››æ­¥ï¼šé›†æˆåˆ°ç°æœ‰æœåŠ¡

#### 4.1 æ›´æ–° `PlotDataService`

```csharp
// åœ¨ PlotDataService ä¸­æ·»åŠ  ActRepository æ”¯æŒ
public class PlotDataService : IDisposable
{
    private readonly ActRepository _actRepository;
    // ... å…¶ä»–ç°æœ‰ä»£ç  ...

    public PlotDataService(string initActName = "default")
    {
        // ... ç°æœ‰åˆå§‹åŒ–ä»£ç  ...
        _actRepository = new ActRepository(_connectionString);
    }

    public async Task<Act> GetActByNameAsync(string title)
    {
        return await _actRepository.GetByTitleAsync(title);
    }

    public async Task<IEnumerable<Act>> GetAllActsAsync()
    {
        return await _actRepository.GetAllAsync();
    }
}
```

### ç¬¬äº”æ­¥ï¼šéªŒè¯é›†æˆ

#### 5.1 è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
dotnet test

# æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡
dotnet test --collect:"XPlat Code Coverage"
```

#### 5.2 æ‰‹åŠ¨æµ‹è¯•

```csharp
// åœ¨ MainWindow.xaml.cs ä¸­æ·»åŠ æµ‹è¯•ä»£ç 
private async void TestDatabaseIntegration()
{
    try
    {
        using var plotService = new PlotDataService();
        
        // æµ‹è¯•è·å–æ‰€æœ‰ç« èŠ‚
        var acts = await plotService.GetAllActsAsync();
        MessageBox.Show($"æ‰¾åˆ° {acts.Count()} ä¸ªç« èŠ‚");
        
        // æµ‹è¯•è·å–ç‰¹å®šç« èŠ‚
        var act = await plotService.GetActByNameAsync("default");
        if (act != null)
        {
            MessageBox.Show($"æ‰¾åˆ°ç« èŠ‚: {act.Title}");
        }
    }
    catch (Exception ex)
    {
        MessageBox.Show($"æµ‹è¯•å¤±è´¥: {ex.Message}");
    }
}
```

## ğŸ“‹ ä¸‹ä¸€æ­¥è®¡åˆ’

### ç«‹å³å¯ä»¥å¼€å§‹çš„ä»»åŠ¡

1. **åˆ›å»º PlotEntity å’Œ PlotRepository**
   - å‚è€ƒ ActEntity çš„å®ç°æ¨¡å¼
   - å®ç°å®Œæ•´çš„ CRUD æ“ä½œ
   - æ·»åŠ ç›¸åº”çš„æµ‹è¯•

2. **åˆ›å»º FormattedTextEntryEntity å’Œ Repository**
   - å¤„ç†å¤æ‚çš„ JSON å­—æ®µæ˜ å°„
   - å®ç°ä¸ Plot çš„å…³è”å…³ç³»
   - æ·»åŠ æ•°æ®éªŒè¯

3. **å®ç°æ•°æ®è¿ç§»æœåŠ¡**
   - åˆ›å»º JSON åˆ°æ•°æ®åº“çš„è¿ç§»è„šæœ¬
   - å®ç°æ•°æ®éªŒè¯å’Œæ¸…ç†
   - æ·»åŠ å¤‡ä»½å’Œæ¢å¤åŠŸèƒ½

### æœ¬å‘¨ç›®æ ‡

- [ ] å®Œæˆæ‰€æœ‰ Entity ç±»çš„åˆ›å»º
- [ ] å®Œæˆæ‰€æœ‰ Repository ç±»çš„å®ç°
- [ ] å®Œæˆæ‰€æœ‰ Mapper ç±»çš„å®ç°
- [ ] é€šè¿‡æ‰€æœ‰å•å…ƒæµ‹è¯•
- [ ] å®ç°åŸºç¡€çš„æ•°æ®è¿ç§»åŠŸèƒ½

### ä¸‹å‘¨ç›®æ ‡

- [ ] é‡æ„ç°æœ‰æœåŠ¡ç±»
- [ ] å®ç°æ–°çš„æœåŠ¡æ¥å£
- [ ] æ›´æ–° ViewModel å±‚
- [ ] æ·»åŠ å¼‚æ­¥æ“ä½œæ”¯æŒ
- [ ] å®ç°é”™è¯¯å¤„ç†æœºåˆ¶

## ğŸ”§ å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜1ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
```csharp
// æ£€æŸ¥è¿æ¥å­—ç¬¦ä¸²
var connectionString = $"Data Source={dbPath};Version=3;";
// ç¡®ä¿æ•°æ®åº“æ–‡ä»¶è·¯å¾„å­˜åœ¨
Directory.CreateDirectory(Path.GetDirectoryName(dbPath));
```

### é—®é¢˜2ï¼šè¿ç§»è„šæœ¬æ‰§è¡Œå¤±è´¥
```csharp
// æ£€æŸ¥è¿ç§»ç‰ˆæœ¬
DatabaseMigration.Migrate(_connectionString);
// ç¡®ä¿æ‰€æœ‰SQLè¯­å¥è¯­æ³•æ­£ç¡®
```

### é—®é¢˜3ï¼šæµ‹è¯•æ•°æ®æ¸…ç†å¤±è´¥
```csharp
// ä½¿ç”¨ try-catch åŒ…è£…æ¸…ç†ä»£ç 
try
{
    if (File.Exists(_testDbPath))
    {
        File.Delete(_testDbPath);
    }
}
catch
{
    // å¿½ç•¥æ¸…ç†å¤±è´¥
}
```

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœåœ¨å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹ç°æœ‰æµ‹è¯•**ï¼šå‚è€ƒ `PrtsDataRepositoryTests` çš„å®ç°
2. **æ£€æŸ¥å¼‚å¸¸å¤„ç†**ï¼šæŸ¥çœ‹ `DatabaseException` ç±»çš„ä½¿ç”¨
3. **éªŒè¯æ•°æ®æ˜ å°„**ï¼šå‚è€ƒ `PrtsDataMapper` çš„å®ç°æ¨¡å¼
4. **è¿è¡Œæµ‹è¯•**ï¼šç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½æœ‰å¯¹åº”çš„æµ‹è¯•éªŒè¯

## ğŸ¯ æˆåŠŸæ ‡å‡†

å®Œæˆç¬¬ä¸€é˜¶æ®µåï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] æˆåŠŸåˆ›å»ºå’Œè¿è¡Œæ‰€æœ‰æ–°çš„ Repository ç±»
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œè¦†ç›–ç‡ > 80%
- [ ] æ•°æ®åº“è¿ç§»ç³»ç»Ÿæ­£å¸¸å·¥ä½œ
- [ ] ç°æœ‰åŠŸèƒ½ä¸å—å½±å“
- [ ] æ–°çš„æ•°æ®è®¿é—®å±‚å¯ä»¥æ­£å¸¸å·¥ä½œ

å‡†å¤‡å¥½å¼€å§‹äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹ç¬¬ä¸€é˜¶æ®µçš„å®æ–½ï¼ 