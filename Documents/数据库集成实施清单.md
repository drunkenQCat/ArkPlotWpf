# 数据库集成实施清单

## 第一阶段：基础架构迁移

### 1.1 数据库迁移系统完善
- [ ] **任务1.1.1**：扩展 `DatabaseMigration` 类
  - [ ] 添加版本控制机制
  - [ ] 实现迁移脚本管理
  - [ ] 添加回滚功能
  - [ ] 实现迁移状态跟踪

- [ ] **任务1.1.2**：创建迁移脚本
  ```sql
  -- 迁移脚本示例
  -- 001_InitialSchema.sql
  -- 002_AddIndexes.sql
  -- 003_AddConstraints.sql
  ```

### 1.2 Repository层实现
- [ ] **任务1.2.1**：实现 `PlotRepository`
  ```csharp
  public class PlotRepository : BaseRepository, IPlotRepository
  {
      public async Task<Plot> GetByTitleAsync(string title);
      public async Task<IEnumerable<Plot>> GetByActIdAsync(long actId);
      public async Task<long> AddAsync(Plot plot);
      public async Task<bool> UpdateAsync(Plot plot);
      public async Task<bool> DeleteAsync(long id);
  }
  ```

- [ ] **任务1.2.2**：实现 `FormattedTextEntryRepository`
  ```csharp
  public class FormattedTextEntryRepository : BaseRepository, IFormattedTextEntryRepository
  {
      public async Task<IEnumerable<FormattedTextEntry>> GetByPlotIdAsync(long plotId);
      public async Task<long> AddAsync(FormattedTextEntry entry);
      public async Task<bool> UpdateAsync(FormattedTextEntry entry);
      public async Task<bool> DeleteAsync(long id);
  }
  ```

- [ ] **任务1.2.3**：实现 `ActRepository`
  ```csharp
  public class ActRepository : BaseRepository, IActRepository
  {
      public async Task<Act> GetByTitleAsync(string title);
      public async Task<IEnumerable<Act>> GetAllAsync();
      public async Task<long> AddAsync(Act act);
      public async Task<bool> UpdateAsync(Act act);
      public async Task<bool> DeleteAsync(long id);
  }
  ```

- [ ] **任务1.2.4**：实现 `TagReplacementRuleRepository`
  ```csharp
  public class TagReplacementRuleRepository : BaseRepository, ITagReplacementRuleRepository
  {
      public async Task<IEnumerable<TagReplacementRule>> GetActiveRulesAsync();
      public async Task<TagReplacementRule> GetByTagAsync(string tag);
      public async Task<long> AddAsync(TagReplacementRule rule);
      public async Task<bool> UpdateAsync(TagReplacementRule rule);
      public async Task<bool> DeleteAsync(long id);
  }
  ```

### 1.3 Mapper层实现
- [ ] **任务1.3.1**：实现 `PlotMapper`
  ```csharp
  public class PlotMapper : IMapper<Plot, PlotEntity>
  {
      public PlotEntity ToEntity(Plot model);
      public Plot ToModel(PlotEntity entity);
  }
  ```

- [ ] **任务1.3.2**：实现 `FormattedTextEntryMapper`
  ```csharp
  public class FormattedTextEntryMapper : IMapper<FormattedTextEntry, FormattedTextEntryEntity>
  {
      public FormattedTextEntryEntity ToEntity(FormattedTextEntry model);
      public FormattedTextEntry ToModel(FormattedTextEntryEntity entity);
  }
  ```

- [ ] **任务1.3.3**：实现 `ActMapper`
  ```csharp
  public class ActMapper : IMapper<Act, ActEntity>
  {
      public ActEntity ToEntity(Act model);
      public Act ToModel(ActEntity entity);
  }
  ```

- [ ] **任务1.3.4**：实现 `TagReplacementRuleMapper`
  ```csharp
  public class TagReplacementRuleMapper : IMapper<TagReplacementRule, TagReplacementRuleEntity>
  {
      public TagReplacementRuleEntity ToEntity(TagReplacementRule model);
      public TagReplacementRule ToModel(TagReplacementRuleEntity entity);
  }
  ```

### 1.4 Entity层实现
- [ ] **任务1.4.1**：创建 `PlotEntity`
  ```csharp
  public class PlotEntity
  {
      public long Id { get; set; }
      public string Title { get; set; } = string.Empty;
      public string Content { get; set; } = string.Empty;
      public long ActId { get; set; }
      public DateTime CreatedAt { get; set; }
      public DateTime UpdatedAt { get; set; }
  }
  ```

- [ ] **任务1.4.2**：创建 `FormattedTextEntryEntity`
  ```csharp
  public class FormattedTextEntryEntity
  {
      public long Id { get; set; }
      public long PlotId { get; set; }
      public int IndexNo { get; set; }
      public string OriginalText { get; set; } = string.Empty;
      public string MdText { get; set; } = string.Empty;
      public int MdDuplicateCounter { get; set; }
      public string TypText { get; set; } = string.Empty;
      public string Type { get; set; } = string.Empty;
      public bool IsTagOnly { get; set; }
      public string CharacterName { get; set; } = string.Empty;
      public string Dialog { get; set; } = string.Empty;
      public int PngIndex { get; set; }
      public string Bg { get; set; } = string.Empty;
      public string ResourceUrls { get; set; } = string.Empty; // JSON
      public string PortraitsInfo { get; set; } = string.Empty; // JSON
      public string CommandSet { get; set; } = string.Empty; // JSON
      public DateTime CreatedAt { get; set; }
  }
  ```

- [ ] **任务1.4.3**：创建 `ActEntity`
  ```csharp
  public class ActEntity
  {
      public long Id { get; set; }
      public string Title { get; set; } = string.Empty;
      public DateTime CreatedAt { get; set; }
      public DateTime UpdatedAt { get; set; }
  }
  ```

- [ ] **任务1.4.4**：创建 `TagReplacementRuleEntity`
  ```csharp
  public class TagReplacementRuleEntity
  {
      public long Id { get; set; }
      public string Tag { get; set; } = string.Empty;
      public string Replacement { get; set; } = string.Empty;
      public bool IsActive { get; set; }
      public DateTime CreatedAt { get; set; }
  }
  ```

## 第二阶段：数据迁移

### 2.1 数据迁移服务
- [ ] **任务2.1.1**：创建 `DataMigrationService`
  ```csharp
  public class DataMigrationService
  {
      private readonly PlotRepository _plotRepository;
      private readonly PrtsDataRepository _prtsDataRepository;
      private readonly TagReplacementRuleRepository _ruleRepository;
      
      public async Task MigrateAllDataAsync();
      public async Task MigratePlotsFromJsonAsync(string jsonFilePath);
      public async Task MigrateTagsFromJsonAsync(string jsonFilePath);
      public async Task MigratePrtsAssetsAsync();
      public async Task ValidateMigrationAsync();
  }
  ```

- [ ] **任务2.1.2**：实现JSON文件解析
  ```csharp
  public class JsonDataParser
  {
      public async Task<List<Plot>> ParsePlotsFromJsonAsync(string filePath);
      public async Task<List<TagReplacementRule>> ParseTagsFromJsonAsync(string filePath);
      public async Task<PrtsAssets> ParsePrtsAssetsFromJsonAsync(string filePath);
  }
  ```

### 2.2 数据验证
- [ ] **任务2.2.1**：创建数据验证服务
  ```csharp
  public class DataValidationService
  {
      public async Task<ValidationResult> ValidatePlotDataAsync(Plot plot);
      public async Task<ValidationResult> ValidateFormattedTextEntryAsync(FormattedTextEntry entry);
      public async Task<ValidationResult> ValidatePrtsDataAsync(PrtsData prtsData);
      public async Task<ValidationResult> ValidateMigrationAsync();
  }
  ```

- [ ] **任务2.2.2**：实现数据清理
  ```csharp
  public class DataCleanupService
  {
      public async Task RemoveDuplicatePlotsAsync();
      public async Task RemoveInvalidEntriesAsync();
      public async Task NormalizeDataAsync();
      public async Task CreateBackupAsync();
  }
  ```

## 第三阶段：服务层重构

### 3.1 重构现有服务
- [ ] **任务3.1.1**：重构 `PlotDataService`
  ```csharp
  public class PlotDataService : IPlotDataService, IDisposable
  {
      private readonly PlotRepository _plotRepository;
      private readonly FormattedTextEntryRepository _entryRepository;
      private readonly ActRepository _actRepository;
      
      public async Task<Plot> GetPlotByNameAsync(string title);
      public async Task<IEnumerable<Plot>> GetAllPlotsAsync();
      public async Task<long> AddPlotAsync(Plot plot);
      public async Task<bool> UpdatePlotAsync(Plot plot);
      public async Task<bool> DeletePlotAsync(string title);
  }
  ```

- [ ] **任务3.1.2**：创建 `PrtsDataService`
  ```csharp
  public class PrtsDataService : IPrtsDataService, IDisposable
  {
      private readonly PrtsDataRepository _prtsDataRepository;
      private readonly PrtsAssetsRepository _prtsAssetsRepository;
      
      public async Task<PrtsData> GetPrtsDataByTagAsync(string tag);
      public async Task<IEnumerable<PrtsData>> GetAllPrtsDataAsync();
      public async Task<long> AddPrtsDataAsync(PrtsData prtsData);
      public async Task<bool> UpdatePrtsDataAsync(PrtsData prtsData);
      public async Task<bool> DeletePrtsDataAsync(string tag);
      public async Task<PrtsAssets> LoadPrtsAssetsAsync();
      public async Task SavePrtsAssetsAsync(PrtsAssets prtsAssets);
  }
  ```

### 3.2 新服务实现
- [ ] **任务3.2.1**：创建 `TagProcessingService`
  ```csharp
  public class TagProcessingService : ITagProcessingService
  {
      private readonly TagReplacementRuleRepository _ruleRepository;
      
      public async Task<string> ProcessTagsAsync(string content);
      public async Task<IEnumerable<TagReplacementRule>> GetActiveRulesAsync();
      public async Task<long> AddRuleAsync(TagReplacementRule rule);
      public async Task<bool> UpdateRuleAsync(TagReplacementRule rule);
      public async Task<bool> DeleteRuleAsync(long id);
  }
  ```

- [ ] **任务3.2.2**：创建 `BackupService`
  ```csharp
  public class BackupService : IBackupService
  {
      public async Task CreateBackupAsync(string backupPath);
      public async Task RestoreBackupAsync(string backupPath);
      public async Task<List<BackupInfo>> GetBackupHistoryAsync();
      public async Task<bool> ValidateBackupAsync(string backupPath);
  }
  ```

## 第四阶段：UI层适配

### 4.1 ViewModel更新
- [ ] **任务4.1.1**：更新 `MainViewModel`
  ```csharp
  public class MainViewModel : ObservableObject
  {
      private readonly IPlotDataService _plotService;
      private readonly IPrtsDataService _prtsService;
      private readonly ITagProcessingService _tagService;
      
      public ObservableCollection<Plot> Plots { get; set; }
      public bool IsLoading { get; set; }
      public string ErrorMessage { get; set; }
      
      public IAsyncRelayCommand LoadPlotsCommand { get; }
      public IAsyncRelayCommand<Plot> SavePlotCommand { get; }
      public IAsyncRelayCommand<Plot> DeletePlotCommand { get; }
      
      private async Task LoadPlotsAsync();
      private async Task SavePlotAsync(Plot plot);
      private async Task DeletePlotAsync(Plot plot);
  }
  ```

- [ ] **任务4.1.2**：更新 `TagEditorViewModel`
  ```csharp
  public class TagEditorViewModel : ObservableObject
  {
      private readonly ITagProcessingService _tagService;
      
      public ObservableCollection<TagReplacementRule> Rules { get; set; }
      public TagReplacementRule SelectedRule { get; set; }
      
      public IAsyncRelayCommand LoadRulesCommand { get; }
      public IAsyncRelayCommand AddRuleCommand { get; }
      public IAsyncRelayCommand UpdateRuleCommand { get; }
      public IAsyncRelayCommand DeleteRuleCommand { get; }
  }
  ```

### 4.2 异步操作支持
- [ ] **任务4.2.1**：实现加载状态管理
  ```csharp
  public class LoadingStateManager
  {
      public bool IsLoading { get; set; }
      public string LoadingMessage { get; set; }
      public double Progress { get; set; }
      
      public IDisposable BeginLoading(string message = "加载中...");
      public void UpdateProgress(double progress);
      public void EndLoading();
  }
  ```

- [ ] **任务4.2.2**：实现错误处理
  ```csharp
  public class ErrorHandler
  {
      public static void HandleDatabaseException(DatabaseException ex);
      public static void HandleValidationException(ValidationException ex);
      public static void HandleGeneralException(Exception ex);
      public static void ShowErrorToUser(string message);
  }
  ```

## 第五阶段：测试和优化

### 5.1 测试实现
- [ ] **任务5.1.1**：创建集成测试
  ```csharp
  public class DatabaseIntegrationTests
  {
      [Fact]
      public async Task FullWorkflow_ShouldWorkCorrectly();
      
      [Fact]
      public async Task DataMigration_ShouldPreserveDataIntegrity();
      
      [Fact]
      public async Task ConcurrentOperations_ShouldHandleCorrectly();
  }
  ```

- [ ] **任务5.1.2**：创建性能测试
  ```csharp
  public class PerformanceTests
  {
      [Fact]
      public async Task QueryPerformance_ShouldMeetRequirements();
      
      [Fact]
      public async Task MemoryUsage_ShouldBeOptimized();
      
      [Fact]
      public async Task ConcurrentLoad_ShouldHandleCorrectly();
  }
  ```

### 5.2 性能优化
- [ ] **任务5.2.1**：数据库优化
  - [ ] 添加适当的索引
  - [ ] 优化查询语句
  - [ ] 实现连接池
  - [ ] 配置数据库参数

- [ ] **任务5.2.2**：内存优化
  - [ ] 实现数据分页加载
  - [ ] 优化对象生命周期
  - [ ] 实现缓存机制
  - [ ] 减少内存泄漏

## 检查点和验收标准

### 第一阶段验收标准
- [ ] 所有Repository类实现完成并通过测试
- [ ] 所有Mapper类实现完成并通过测试
- [ ] 数据库迁移系统正常工作
- [ ] 代码覆盖率 > 80%

### 第二阶段验收标准
- [ ] 数据迁移成功，无数据丢失
- [ ] 数据验证通过，无数据错误
- [ ] 迁移性能满足要求
- [ ] 备份和恢复功能正常

### 第三阶段验收标准
- [ ] 所有服务重构完成
- [ ] 服务接口统一且易用
- [ ] 错误处理完善
- [ ] 性能不低于原有系统

### 第四阶段验收标准
- [ ] UI响应正常，无卡顿
- [ ] 异步操作流畅
- [ ] 错误提示友好
- [ ] 用户体验良好

### 第五阶段验收标准
- [ ] 所有测试通过
- [ ] 性能指标达标
- [ ] 内存使用优化
- [ ] 系统稳定运行

## 风险评估和应对

### 高风险任务
1. **数据迁移**：可能导致数据丢失
   - 应对：完整备份，分步迁移，充分测试

2. **性能问题**：数据库查询可能比文件读取慢
   - 应对：优化查询，添加索引，实现缓存

3. **兼容性问题**：现有功能可能受影响
   - 应对：保持向后兼容，渐进式迁移

### 中风险任务
1. **代码复杂度增加**：新架构可能增加复杂度
   - 应对：良好的文档和代码规范

2. **测试覆盖不足**：新功能可能缺乏测试
   - 应对：编写全面的测试用例

### 低风险任务
1. **UI适配**：界面调整相对简单
2. **文档更新**：技术文档更新

## 时间安排

| 阶段 | 预计时间 | 关键里程碑 |
|------|----------|------------|
| 第一阶段 | 1-2周 | 基础架构完成 |
| 第二阶段 | 1周 | 数据迁移完成 |
| 第三阶段 | 1-2周 | 服务层重构完成 |
| 第四阶段 | 1周 | UI适配完成 |
| 第五阶段 | 1周 | 测试优化完成 |

**总计：5-7周**

## 成功指标

### 技术指标
- [ ] 代码覆盖率 > 80%
- [ ] 数据库查询响应时间 < 100ms
- [ ] 内存使用优化 20%
- [ ] 零数据丢失

### 功能指标
- [ ] 所有现有功能正常工作
- [ ] 数据完整性100%保持
- [ ] 性能不低于现有系统
- [ ] 错误处理完善

### 用户体验指标
- [ ] 操作响应时间无明显延迟
- [ ] 错误提示清晰友好
- [ ] 数据加载状态明确
- [ ] 功能操作流程顺畅 