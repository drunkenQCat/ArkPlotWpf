# ArkPlot 数据库集成规划文档

## 1. 项目现状分析

### 1.1 当前数据管理方式
目前项目主要使用以下方式管理数据：
- **文件存储**：`all_plots.json`、`all_plots_1.json` 等JSON文件
- **内存存储**：`PrtsAssets` 单例模式管理资源数据
- **临时存储**：`PrtsData` 用于临时数据存储
- **现有数据库**：`PlotDataService` 已实现基础的SQLite数据库功能

### 1.2 现有数据库架构
```sql
-- 当前已实现的表结构
Acts (Id, Title)
Plots (Id, Title, Content, ActId)
FormattedTextEntries (Id, PlotId, IndexNo, OriginalText, MdText, ...)
```

### 1.3 新开发的数据库模块
- **BaseRepository**：通用数据库操作基类
- **PrtsDataRepository**：PRTS数据管理
- **PrtsAssetsRepository**：PRTS资源管理
- **数据验证**：`DataValidator` 类
- **异常处理**：自定义数据库异常体系
- **数据映射**：`PrtsDataMapper` 等映射器

## 2. 集成目标

### 2.1 主要目标
1. **统一数据管理**：将所有数据迁移到数据库
2. **提高性能**：减少文件I/O，优化查询性能
3. **数据一致性**：确保数据完整性和一致性
4. **可扩展性**：支持未来功能扩展
5. **用户体验**：保持现有功能的同时提升性能

### 2.2 具体改进
- 替换JSON文件存储为数据库存储
- 优化 `PrtsAssets` 单例模式
- 统一数据访问接口
- 添加数据验证和错误处理
- 支持数据备份和恢复

## 3. 数据库架构设计

### 3.1 核心表结构

```sql
-- 1. 章节表 (Acts)
CREATE TABLE Acts (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Title TEXT NOT NULL UNIQUE,
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 2. 剧情表 (Plots)
CREATE TABLE Plots (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Title TEXT NOT NULL UNIQUE,
    Content TEXT NOT NULL,
    ActId INTEGER NOT NULL,
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ActId) REFERENCES Acts(Id) ON DELETE CASCADE
);

-- 3. 格式化文本条目表 (FormattedTextEntries)
CREATE TABLE FormattedTextEntries (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    PlotId INTEGER NOT NULL,
    IndexNo INTEGER,
    OriginalText TEXT,
    MdText TEXT,
    MdDuplicateCounter INTEGER DEFAULT 0,
    TypText TEXT,
    Type TEXT,
    IsTagOnly INTEGER DEFAULT 0,
    CharacterName TEXT,
    Dialog TEXT,
    PngIndex INTEGER DEFAULT 0,
    Bg TEXT,
    ResourceUrls TEXT, -- JSON格式
    PortraitsInfo TEXT, -- JSON格式
    CommandSet TEXT, -- JSON格式
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (PlotId) REFERENCES Plots(Id) ON DELETE CASCADE
);

-- 4. PRTS数据表 (PrtsData)
CREATE TABLE PrtsData (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Tag TEXT NOT NULL UNIQUE,
    DataJson TEXT NOT NULL, -- JSON格式存储
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 5. 标签替换规则表 (TagReplacementRules)
CREATE TABLE TagReplacementRules (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Tag TEXT NOT NULL,
    Replacement TEXT NOT NULL,
    IsActive INTEGER DEFAULT 1,
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 6. 媒体类型表 (MediaTypes)
CREATE TABLE MediaTypes (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Name TEXT NOT NULL UNIQUE,
    Description TEXT,
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 索引设计
```sql
-- 性能优化索引
CREATE INDEX idx_plots_actid ON Plots(ActId);
CREATE INDEX idx_plots_title ON Plots(Title);
CREATE INDEX idx_entries_plotid ON FormattedTextEntries(PlotId);
CREATE INDEX idx_entries_indexno ON FormattedTextEntries(IndexNo);
CREATE INDEX idx_prtsdata_tag ON PrtsData(Tag);
CREATE INDEX idx_rules_tag ON TagReplacementRules(Tag);
```

## 4. 集成实施计划

### 4.1 第一阶段：基础架构迁移（1-2周）

#### 4.1.1 数据库迁移系统
- [x] 完善 `DatabaseMigration` 类
- [ ] 添加版本控制和回滚机制
- [ ] 实现数据迁移脚本

#### 4.1.2 统一数据访问层
- [x] 实现 `BaseRepository` 基类
- [x] 实现 `PrtsDataRepository`
- [x] 实现 `PrtsAssetsRepository`
- [ ] 实现 `PlotRepository`
- [ ] 实现 `FormattedTextEntryRepository`
- [ ] 实现 `TagReplacementRuleRepository`

#### 4.1.3 数据映射器
- [x] 实现 `PrtsDataMapper`
- [ ] 实现 `PlotMapper`
- [ ] 实现 `FormattedTextEntryMapper`
- [ ] 实现 `TagReplacementRuleMapper`

### 4.2 第二阶段：数据迁移（1周）

#### 4.2.1 JSON文件迁移
```csharp
// 迁移脚本示例
public class DataMigrationService
{
    public async Task MigrateJsonFilesToDatabase()
    {
        // 1. 迁移 all_plots.json
        await MigratePlotsFromJson("all_plots.json");
        
        // 2. 迁移 tags.json
        await MigrateTagsFromJson("tags.json");
        
        // 3. 迁移 PrtsAssets 数据
        await MigratePrtsAssets();
    }
}
```

#### 4.2.2 数据验证和清理
- [ ] 实现数据完整性检查
- [ ] 清理重复和无效数据
- [ ] 验证数据格式一致性

### 4.3 第三阶段：服务层重构（1-2周）

#### 4.3.1 重构现有服务
```csharp
// 新的 PlotDataService
public class PlotDataService : IDisposable
{
    private readonly PlotRepository _plotRepository;
    private readonly FormattedTextEntryRepository _entryRepository;
    private readonly ActRepository _actRepository;
    
    public PlotDataService()
    {
        _plotRepository = new PlotRepository();
        _entryRepository = new FormattedTextEntryRepository();
        _actRepository = new ActRepository();
    }
    
    // 使用Repository模式的方法
    public async Task<Plot> GetPlotByNameAsync(string title)
    {
        return await _plotRepository.GetByTitleAsync(title);
    }
}
```

#### 4.3.2 新服务实现
- [ ] `PrtsDataService`：统一PRTS数据管理
- [ ] `TagProcessingService`：标签处理服务
- [ ] `DataValidationService`：数据验证服务
- [ ] `BackupService`：数据备份服务

### 4.4 第四阶段：UI层适配（1周）

#### 4.4.1 ViewModel更新
```csharp
// 更新 MainViewModel
public class MainViewModel : ObservableObject
{
    private readonly PlotDataService _plotService;
    private readonly PrtsDataService _prtsService;
    
    public async Task LoadPlotsAsync()
    {
        try
        {
            var plots = await _plotService.GetAllPlotsAsync();
            // 更新UI
        }
        catch (DatabaseException ex)
        {
            // 错误处理
        }
    }
}
```

#### 4.4.2 异步操作支持
- [ ] 实现异步数据加载
- [ ] 添加加载状态指示
- [ ] 实现错误处理和用户提示

### 4.5 第五阶段：测试和优化（1周）

#### 4.5.1 测试覆盖
- [x] 单元测试（已完成）
- [ ] 集成测试
- [ ] 性能测试
- [ ] 用户验收测试

#### 4.5.2 性能优化
- [ ] 查询性能优化
- [ ] 内存使用优化
- [ ] 数据库连接池优化

## 5. 技术实现细节

### 5.1 依赖注入配置
```csharp
// 在 App.xaml.cs 中配置服务
public partial class App : Application
{
    protected override void OnStartup(StartupEventArgs e)
    {
        // 配置数据库连接
        var connectionString = GetConnectionString();
        
        // 注册服务
        var services = new ServiceCollection();
        services.AddSingleton<IPlotDataService, PlotDataService>();
        services.AddSingleton<IPrtsDataService, PrtsDataService>();
        services.AddSingleton<IDataValidationService, DataValidationService>();
        
        // 配置依赖注入容器
        var serviceProvider = services.BuildServiceProvider();
        
        base.OnStartup(e);
    }
}
```

### 5.2 数据访问模式
```csharp
// Repository模式 + Unit of Work模式
public class UnitOfWork : IDisposable
{
    private readonly IDbConnection _connection;
    private readonly IDbTransaction _transaction;
    
    public PlotRepository Plots { get; }
    public PrtsDataRepository PrtsData { get; }
    
    public async Task CommitAsync()
    {
        await _transaction.CommitAsync();
    }
    
    public async Task RollbackAsync()
    {
        await _transaction.RollbackAsync();
    }
}
```

### 5.3 错误处理策略
```csharp
// 统一的错误处理
public class DatabaseErrorHandler
{
    public static async Task<T> ExecuteWithRetryAsync<T>(Func<Task<T>> operation)
    {
        var retryCount = 0;
        while (retryCount < 3)
        {
            try
            {
                return await operation();
            }
            catch (DatabaseConnectionException ex)
            {
                retryCount++;
                if (retryCount >= 3) throw;
                await Task.Delay(1000 * retryCount);
            }
        }
        throw new DatabaseException("操作失败，已重试3次");
    }
}
```

## 6. 风险评估和应对策略

### 6.1 主要风险
1. **数据丢失风险**：迁移过程中可能丢失数据
2. **性能下降风险**：数据库查询可能比文件读取慢
3. **兼容性风险**：现有功能可能受影响
4. **用户接受度风险**：用户可能不适应新系统

### 6.2 应对策略
1. **数据备份**：迁移前完整备份所有数据
2. **渐进式迁移**：分阶段迁移，保持向后兼容
3. **性能监控**：实时监控系统性能
4. **用户培训**：提供用户指南和培训

## 7. 成功标准

### 7.1 功能标准
- [ ] 所有现有功能正常工作
- [ ] 数据完整性100%保持
- [ ] 性能不低于现有系统
- [ ] 错误处理完善

### 7.2 技术标准
- [ ] 代码覆盖率 > 80%
- [ ] 数据库查询响应时间 < 100ms
- [ ] 内存使用优化 20%
- [ ] 零数据丢失

### 7.3 用户体验标准
- [ ] 操作响应时间无明显延迟
- [ ] 错误提示清晰友好
- [ ] 数据加载状态明确
- [ ] 功能操作流程顺畅

## 8. 后续维护计划

### 8.1 定期维护
- 数据库性能监控
- 数据备份和恢复测试
- 索引优化
- 数据清理

### 8.2 功能扩展
- 数据导入导出功能
- 数据同步功能
- 多用户支持
- 云端备份

## 9. 总结

通过这个数据库集成计划，我们将：
1. **提升系统性能**：减少文件I/O，优化数据访问
2. **增强数据安全性**：统一的数据验证和错误处理
3. **提高可维护性**：清晰的分层架构和代码组织
4. **支持未来扩展**：灵活的数据库架构设计

这个计划将分5个阶段实施，预计总工期5-7周，每个阶段都有明确的目标和验收标准，确保项目顺利进行。 